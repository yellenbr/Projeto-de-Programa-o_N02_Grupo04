<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årea do Instrutor - Veridia</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>√Årea do Instrutor</h1>
                    <p id="nomeInstrutor">Bem-vindo(a)!</p>
                </div>
                <button onclick="logout()" class="btn-outline" title="Sair do sistema">
                    üö™ Sair
                </button>
            </div>
        </header>

        <nav class="menu">
            <button onclick="showSection('meusDados')" class="nav-btn active">
                <span></span> Meus Dados
            </button>
            <button onclick="showSection('meusCursos')" class="nav-btn">
                <span></span> Meus Cursos
            </button>
            <button onclick="showSection('gerenciarCursos')" class="nav-btn">
                <span></span> Criar Curso
            </button>
            <button onclick="showSection('alunosInscritos')" class="nav-btn">
                <span></span> Alunos Inscritos
            </button>
        </nav>

        <!-- MEUS DADOS -->
        <section id="meusDados" class="content-section active">
            <h2>Meus Dados</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalCursosInstrutor">0</h3>
                    <p>Total de Cursos</p>
                </div>
                <div class="stat-card">
                    <h3 id="cursosAtivosInstrutor">0</h3>
                    <p>Cursos Ativos</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalAlunosInstrutor">0</h3>
                    <p>Total de Alunos</p>
                </div>
                <div class="stat-card">
                    <h3 id="receitaTotalInstrutor">R$ 0</h3>
                    <p>Receita Total</p>
                </div>
            </div>

            <div class="info-section" style="margin-top: 2rem;">
                <h3>‚ÑπÔ∏è Informa√ß√µes Pessoais</h3>
                <div id="dadosInstrutor"></div>
            </div>
        </section>

        <!-- MEUS CURSOS -->
        <section id="meusCursos" class="content-section">
            <h2>üìö Meus Cursos</h2>
            
            <div class="actions">
                <button onclick="carregarMeusCursos()" class="btn-outline">
                    <span>üîÑ</span> Atualizar
                </button>
            </div>

            <div id="listaMeusCursos" class="data-list"></div>
        </section>

        <!-- GERENCIAR CURSOS -->
        <section id="gerenciarCursos" class="content-section">
            <h2>‚ûï Criar Novo Curso</h2>
            
            <form onsubmit="criarCurso(event)" class="form-container">
                <div class="form-group">
                    <label for="cursoNome">Nome do Curso *</label>
                    <input type="text" id="cursoNome" required placeholder="Ex: Java Completo 2025">
                </div>

                <div class="form-group">
                    <label for="cursoDescricao">Descri√ß√£o</label>
                    <textarea id="cursoDescricao" rows="4" placeholder="Descreva o conte√∫do do curso..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cursoPreco">Pre√ßo (R$) *</label>
                        <input type="number" id="cursoPreco" step="0.01" min="0" required placeholder="599.90">
                    </div>

                    <div class="form-group">
                        <label for="cursoCargaHoraria">Carga Hor√°ria (horas) *</label>
                        <input type="number" id="cursoCargaHoraria" min="1" required placeholder="80">
                    </div>

                    <div class="form-group">
                        <label for="cursoVagas">Limite de Vagas *</label>
                        <input type="number" id="cursoVagas" min="1" required placeholder="50" value="50">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        ‚úì Criar Curso
                    </button>
                    <button type="reset" class="btn-outline">
                        ‚Ü∫ Limpar
                    </button>
                </div>
            </form>
        </section>

        <!-- ALUNOS INSCRITOS -->
        <section id="alunosInscritos" class="content-section">
            <h2>Alunos Inscritos nos Meus Cursos</h2>
            
            <div class="actions">
                <button onclick="carregarAlunosInscritos()" class="btn-outline">
                    <span>üîÑ</span> Atualizar
                </button>
            </div>

            <div id="listaAlunosInscritos" class="data-list"></div>
        </section>
    </div>

    <script src="js/app.js"></script>
    <script>
        const API_URL = 'http://localhost:8080/api';
        let session = null;
        let instrutorLogado = null;

        // Verificar autentica√ß√£o
        window.addEventListener('load', async () => {
            const sessionData = localStorage.getItem('session');
            if (!sessionData) {
                window.location.href = 'login.html';
                return;
            }

            session = JSON.parse(sessionData);
            if (session.tipo !== 'instrutor') {
                alert('Acesso negado! Esta √°rea √© exclusiva para instrutores.');
                window.location.href = 'login.html';
                return;
            }

            instrutorLogado = session.usuario;
            document.getElementById('nomeInstrutor').textContent = `Bem-vindo(a), ${instrutorLogado.nome}!`;
            
            await carregarDadosInstrutor();
            await carregarMeusCursos();
        });

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            // Carregar dados da se√ß√£o
            if (sectionId === 'meusCursos') carregarMeusCursos();
            if (sectionId === 'alunosInscritos') carregarAlunosInscritos();
            if (sectionId === 'meusDados') carregarDadosInstrutor();
        }

        async function carregarDadosInstrutor() {
            try {
                // Buscar cursos do instrutor
                const cursosResp = await fetch(`${API_URL}/cursos`);
                const todosCursos = await cursosResp.json();
                const meusCursos = todosCursos.filter(c => c.instrutor && c.instrutor.id === instrutorLogado.id);

                // Buscar inscri√ß√µes dos cursos
                const inscricoesResp = await fetch(`${API_URL}/inscricoes`);
                const todasInscricoes = await inscricoesResp.json();
                
                let totalAlunos = 0;
                let receitaTotal = 0;

                for (const curso of meusCursos) {
                    const inscricoesCurso = todasInscricoes.filter(i => i.curso.id === curso.id);
                    totalAlunos += inscricoesCurso.length;
                    
                    // Calcular receita (apenas inscri√ß√µes pagas)
                    const inscricoesPagas = inscricoesCurso.filter(i => 
                        i.status === 'PAGO' || i.status === 'CONFIRMADA' || i.status === 'CONCLUIDA'
                    );
                    receitaTotal += inscricoesPagas.length * curso.preco;
                }

                const cursosAtivos = meusCursos.filter(c => c.ativo).length;

                // Atualizar estat√≠sticas
                document.getElementById('totalCursosInstrutor').textContent = meusCursos.length;
                document.getElementById('cursosAtivosInstrutor').textContent = cursosAtivos;
                document.getElementById('totalAlunosInstrutor').textContent = totalAlunos;
                document.getElementById('receitaTotalInstrutor').textContent = `R$ ${receitaTotal.toFixed(2)}`;

                // Mostrar dados pessoais
                const dadosDiv = document.getElementById('dadosInstrutor');
                dadosDiv.innerHTML = `
                    <p><strong>Nome:</strong> ${instrutorLogado.nome}</p>
                    <p><strong>Email:</strong> ${instrutorLogado.email}</p>
                    <p><strong>Especialidade:</strong> ${instrutorLogado.especialidade || 'N√£o informada'}</p>
                    <p><strong>Total de Cursos:</strong> ${meusCursos.length}</p>
                    <p><strong>Cursos Ativos:</strong> ${cursosAtivos}</p>
                `;

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showAlert('Erro ao carregar dados do instrutor', 'error');
            }
        }

        async function carregarMeusCursos() {
            try {
                const response = await fetch(`${API_URL}/cursos`);
                const todosCursos = await response.json();
                const meusCursos = todosCursos.filter(c => c.instrutor && c.instrutor.id === instrutorLogado.id);

                const lista = document.getElementById('listaMeusCursos');
                lista.innerHTML = '';

                if (meusCursos.length === 0) {
                    lista.innerHTML = `
                        <div class="empty-state">
                            <h3>Voc√™ ainda n√£o criou nenhum curso</h3>
                            <p>Clique em "Criar Curso" para come√ßar!</p>
                        </div>
                    `;
                    return;
                }

                for (const curso of meusCursos) {
                    // Buscar detalhes
                    const detalhesResp = await fetch(`${API_URL}/teste/curso/${curso.id}/detalhes`);
                    const detalhes = await detalhesResp.json();

                    const div = document.createElement('div');
                    div.className = 'data-item';
                    div.innerHTML = `
                        <h4>${curso.nome}</h4>
                        <p>${curso.descricao || 'Sem descri√ß√£o'}</p>
                        <p><strong>Pre√ßo:</strong> R$ ${curso.preco.toFixed(2)}</p>
                        <p><strong>Carga Hor√°ria:</strong> ${curso.cargaHoraria}h</p>
                        <p><strong>Alunos Inscritos:</strong> ${detalhes.numeroInscritos || 0}/${curso.vagas}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge ${curso.ativo ? 'badge-success' : 'badge-danger'}">
                                ${curso.ativo ? '‚úì Ativo' : '‚úó Inativo'}
                            </span>
                        </p>
                        <div class="item-actions">
                            <button onclick="verAlunosCurso(${curso.id})" class="btn-primary">
                                üë• Ver Alunos (${detalhes.numeroInscritos || 0})
                            </button>
                            <button onclick="toggleStatusCurso(${curso.id}, ${curso.ativo})" class="btn-outline">
                                ${curso.ativo ? '‚è∏Ô∏è Desativar' : '‚ñ∂Ô∏è Ativar'}
                            </button>
                        </div>
                    `;
                    lista.appendChild(div);
                }

            } catch (error) {
                console.error('Erro ao carregar cursos:', error);
                showAlert('Erro ao carregar seus cursos', 'error');
            }
        }

        async function carregarAlunosInscritos() {
            try {
                const cursosResp = await fetch(`${API_URL}/cursos`);
                const todosCursos = await cursosResp.json();
                const meusCursos = todosCursos.filter(c => c.instrutor && c.instrutor.id === instrutorLogado.id);

                const inscricoesResp = await fetch(`${API_URL}/inscricoes`);
                const todasInscricoes = await inscricoesResp.json();

                const lista = document.getElementById('listaAlunosInscritos');
                lista.innerHTML = '';

                let totalInscricoes = 0;

                for (const curso of meusCursos) {
                    const inscricoesCurso = todasInscricoes.filter(i => i.curso.id === curso.id);
                    
                    if (inscricoesCurso.length > 0) {
                        const cursoDiv = document.createElement('div');
                        cursoDiv.innerHTML = `<h3 style="margin-top: 2rem; color: var(--primary-color);">üìö ${curso.nome} (${inscricoesCurso.length} alunos)</h3>`;
                        lista.appendChild(cursoDiv);

                        inscricoesCurso.forEach(inscricao => {
                            const statusClass = 
                                inscricao.status === 'PAGO' || inscricao.status === 'CONFIRMADA' ? 'badge-success' :
                                inscricao.status === 'PENDENTE' ? 'badge-warning' :
                                inscricao.status === 'CONCLUIDA' ? 'badge-success' :
                                'badge-danger';

                            const div = document.createElement('div');
                            div.className = 'data-item';
                            div.innerHTML = `
                                <h4>${inscricao.aluno.nome}</h4>
                                <p><strong>Email:</strong> ${inscricao.aluno.email}</p>
                                <p><strong>Data de Inscri√ß√£o:</strong> ${new Date(inscricao.dataInscricao).toLocaleString('pt-BR')}</p>
                                <p><strong>Status:</strong> 
                                    <span class="badge ${statusClass}">${inscricao.status}</span>
                                </p>
                                ${inscricao.status === 'CONFIRMADA' || inscricao.status === 'PAGO' ? `
                                    <div class="item-actions">
                                        <button onclick="concluirInscricao(${inscricao.id})" class="btn-primary">
                                            ‚úì Marcar como Conclu√≠da
                                        </button>
                                    </div>
                                ` : ''}
                            `;
                            lista.appendChild(div);
                            totalInscricoes++;
                        });
                    }
                }

                if (totalInscricoes === 0) {
                    lista.innerHTML = `
                        <div class="empty-state">
                            
                            <h3>Nenhum aluno inscrito ainda</h3>
                            <p>Quando alunos se inscreverem em seus cursos, eles aparecer√£o aqui.</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                showAlert('Erro ao carregar alunos inscritos', 'error');
            }
        }

        async function criarCurso(event) {
            event.preventDefault();

            const curso = {
                nome: document.getElementById('cursoNome').value,
                descricao: document.getElementById('cursoDescricao').value,
                preco: parseFloat(document.getElementById('cursoPreco').value),
                cargaHoraria: parseInt(document.getElementById('cursoCargaHoraria').value),
                vagas: parseInt(document.getElementById('cursoVagas').value),
                ativo: true,
                instrutor: { id: instrutorLogado.id }
            };

            try {
                const response = await fetch(`${API_URL}/cursos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(curso)
                });

                if (response.ok) {
                    showAlert('Curso criado com sucesso!', 'success');
                    event.target.reset();
                    carregarDadosInstrutor();
                    carregarMeusCursos();
                } else {
                    const error = await response.json();
                    showAlert(error.mensagem || 'Erro ao criar curso', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao criar curso', 'error');
            }
        }

        async function verAlunosCurso(cursoId) {
            try {
                const response = await fetch(`${API_URL}/inscricoes`);
                const todasInscricoes = await response.json();
                const inscricoesCurso = todasInscricoes.filter(i => i.curso.id === cursoId);

                let html = '<h3>Alunos Inscritos</h3>';
                
                if (inscricoesCurso.length === 0) {
                    html += '<p>Nenhum aluno inscrito neste curso.</p>';
                } else {
                    inscricoesCurso.forEach(inscricao => {
                        html += `
                            <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-color);">
                                <p><strong>${inscricao.aluno.nome}</strong></p>
                                <p>Email: ${inscricao.aluno.email}</p>
                                <p>Status: <span class="badge badge-${inscricao.status === 'PAGO' ? 'success' : 'warning'}">${inscricao.status}</span></p>
                            </div>
                        `;
                    });
                }

                mostrarModal('Alunos do Curso', html);
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao carregar alunos do curso', 'error');
            }
        }

        async function toggleStatusCurso(cursoId, ativo) {
            const acao = ativo ? 'desativar' : 'ativar';
            if (!confirm(`Deseja realmente ${acao} este curso?`)) return;

            try {
                // Como n√£o temos endpoint espec√≠fico, vamos buscar o curso e atualizar
                const getResp = await fetch(`${API_URL}/cursos/${cursoId}`);
                const curso = await getResp.json();
                curso.ativo = !ativo;

                const response = await fetch(`${API_URL}/cursos/${cursoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(curso)
                });

                if (response.ok) {
                    showAlert(`Curso ${acao}do com sucesso!`, 'success');
                    carregarMeusCursos();
                } else {
                    showAlert(`Erro ao ${acao} curso`, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert(`Erro ao ${acao} curso`, 'error');
            }
        }

        async function concluirInscricao(inscricaoId) {
            if (!confirm('Confirmar que o aluno concluiu o curso?')) return;

            try {
                const getResp = await fetch(`${API_URL}/inscricoes/${inscricaoId}`);
                const inscricao = await getResp.json();

                const response = await fetch(
                    `${API_URL}/alunos/${inscricao.aluno.id}/inscricoes/${inscricaoId}/concluir`,
                    { method: 'POST' }
                );

                if (response.ok) {
                    showAlert('Inscri√ß√£o marcada como conclu√≠da!', 'success');
                    carregarAlunosInscritos();
                } else {
                    const error = await response.json();
                    showAlert(error.mensagem || 'Erro ao concluir inscri√ß√£o', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao concluir inscri√ß√£o', 'error');
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('session');
                window.location.href = 'login.html';
            }
        }

        function voltarLogin() {
            if (confirm('Deseja voltar para a tela de login? Voc√™ ser√° desconectado.')) {
                localStorage.removeItem('session');
                window.location.href = 'login.html';
            }
        }
    </script>

    <style>
        .form-container {
            max-width: 800px;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
    </style>
</body>
</html>
