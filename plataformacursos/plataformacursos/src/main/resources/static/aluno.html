<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årea do Aluno - Veridia</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üéì √Årea do Aluno</h1>
                    <p id="nomeAluno">Bem-vindo(a)!</p>
                </div>
                <button onclick="logout()" class="btn-outline" title="Sair do sistema">
                    üö™ Sair
                </button>
            </div>
        </header>

        <nav class="menu">
            <button onclick="showSection('meusDados')" class="nav-btn active">
                <span></span> Meus Dados
            </button>
            <button onclick="showSection('cursosDisponiveis')" class="nav-btn">
                <span></span> Cursos Dispon√≠veis
            </button>
            <button onclick="showSection('minhasInscricoes')" class="nav-btn">
                <span></span> Minhas Inscri√ß√µes
            </button>
            <button onclick="showSection('meusPagamentos')" class="nav-btn">
                <span></span> Pagamentos
            </button>
        </nav>

        <!-- MEUS DADOS -->
        <section id="meusDados" class="content-section active">
            <h2>üë§ Meus Dados</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalInscricoesAluno">0</h3>
                    <p>Total de Inscri√ß√µes</p>
                </div>
                <div class="stat-card">
                    <h3 id="cursosAtivosAluno">0</h3>
                    <p>Cursos Ativos</p>
                </div>
                <div class="stat-card">
                    <h3 id="cursosPendentesAluno">0</h3>
                    <p>Pendentes</p>
                </div>
                <div class="stat-card">
                    <h3 id="cursosConcluidosAluno">0</h3>
                    <p>Conclu√≠dos</p>
                </div>
            </div>

            <div class="info-section" style="margin-top: 2rem;">
                <h3>‚ÑπÔ∏è Informa√ß√µes Pessoais</h3>
                <div id="dadosAluno"></div>
            </div>
        </section>

        <!-- CURSOS DISPON√çVEIS -->
        <section id="cursosDisponiveis" class="content-section">
            <h2>üìö Cursos Dispon√≠veis</h2>
            
            <div class="actions">
                <button onclick="carregarCursosDisponiveis()" class="btn-outline">
                    <span>üîÑ</span> Atualizar
                </button>
            </div>

            <div id="listaCursosDisponiveis" class="data-list"></div>
        </section>

        <!-- MINHAS INSCRI√á√ïES -->
        <section id="minhasInscricoes" class="content-section">
            <h2>üìù Minhas Inscri√ß√µes</h2>
            
            <div class="actions">
                <button onclick="carregarMinhasInscricoes()" class="btn-outline">
                    <span>üîÑ</span> Atualizar
                </button>
            </div>

            <div id="listaMinhasInscricoes" class="data-list"></div>
        </section>

        <!-- MEUS PAGAMENTOS -->
        <section id="meusPagamentos" class="content-section">
            <h2>üí∞ Hist√≥rico de Pagamentos</h2>
            
            <div class="actions">
                <button onclick="carregarMeusPagamentos()" class="btn-outline">
                    <span>üîÑ</span> Atualizar
                </button>
            </div>

            <div id="listaMeusPagamentos" class="data-list"></div>
        </section>
    </div>

    <script src="js/app.js"></script>
    <script>
        const API_URL = 'http://localhost:8080/api';
        let session = null;
        let alunoLogado = null;

        // Verificar autentica√ß√£o
        window.addEventListener('load', async () => {
            const sessionData = localStorage.getItem('session');
            if (!sessionData) {
                window.location.href = 'login.html';
                return;
            }

            session = JSON.parse(sessionData);
            if (session.tipo !== 'aluno') {
                alert('Acesso negado! Esta √°rea √© exclusiva para alunos.');
                window.location.href = 'login.html';
                return;
            }

            alunoLogado = session.usuario;
            document.getElementById('nomeAluno').textContent = `Bem-vindo(a), ${alunoLogado.nome}!`;
            
            await carregarDadosAluno();
            await carregarCursosDisponiveis();
        });

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            // Carregar dados da se√ß√£o
            if (sectionId === 'minhasInscricoes') carregarMinhasInscricoes();
            if (sectionId === 'meusPagamentos') carregarMeusPagamentos();
            if (sectionId === 'cursosDisponiveis') carregarCursosDisponiveis();
            if (sectionId === 'meusDados') carregarDadosAluno();
        }

        async function carregarDadosAluno() {
            try {
                const response = await fetch(`${API_URL}/teste/aluno/${alunoLogado.id}/detalhes`);
                const data = await response.json();

                // Atualizar estat√≠sticas
                document.getElementById('totalInscricoesAluno').textContent = data.inscricoes?.length || 0;
                document.getElementById('cursosAtivosAluno').textContent = data.numeroCursosAtivos || 0;
                
                const pendentes = data.inscricoes?.filter(i => i.status === 'PENDENTE').length || 0;
                const concluidos = data.inscricoes?.filter(i => i.status === 'CONCLUIDA').length || 0;
                
                document.getElementById('cursosPendentesAluno').textContent = pendentes;
                document.getElementById('cursosConcluidosAluno').textContent = concluidos;

                // Mostrar dados pessoais
                const dadosDiv = document.getElementById('dadosAluno');
                dadosDiv.innerHTML = `
                    <p><strong>Nome:</strong> ${data.aluno.nome}</p>
                    <p><strong>Email:</strong> ${data.aluno.email}</p>
                    <p><strong>CPF:</strong> ${formatarCPF(data.aluno.cpf)}</p>
                    <p><strong>Cursos Ativos:</strong> ${data.numeroCursosAtivos}/5</p>
                    <p><strong>Pode se Inscrever em Novos Cursos:</strong> 
                        <span class="badge ${data.numeroCursosAtivos < 5 ? 'badge-success' : 'badge-danger'}">
                            ${data.numeroCursosAtivos < 5 ? '‚úì Sim' : '‚úó Limite Atingido'}
                        </span>
                    </p>
                `;

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showAlert('Erro ao carregar dados do aluno', 'error');
            }
        }

        async function carregarCursosDisponiveis() {
            try {
                const response = await fetch(`${API_URL}/cursos`);
                const cursos = await response.json();

                const lista = document.getElementById('listaCursosDisponiveis');
                lista.innerHTML = '';

                if (cursos.length === 0) {
                    lista.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìö</div><h3>Nenhum curso dispon√≠vel</h3></div>';
                    return;
                }

                const cursosAtivos = cursos.filter(c => c.ativo);

                for (const curso of cursosAtivos) {
                    // Buscar detalhes do curso
                    const detalhesResp = await fetch(`${API_URL}/teste/curso/${curso.id}/detalhes`);
                    const detalhes = await detalhesResp.json();

                    const div = document.createElement('div');
                    div.className = 'data-item';
                    div.innerHTML = `
                        <h4>üìö ${curso.nome}</h4>
                        <p>${curso.descricao || 'Sem descri√ß√£o'}</p>
                        <p><strong>Instrutor:</strong> ${detalhes.instrutor?.nome || 'N√£o informado'}</p>
                        <p><strong>Pre√ßo:</strong> R$ ${curso.preco.toFixed(2)}</p>
                        <p><strong>Carga Hor√°ria:</strong> ${curso.cargaHoraria}h</p>
                        <p><strong>Vagas:</strong> ${detalhes.numeroInscritos || 0}/${curso.vagas}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge ${detalhes.vagasDisponiveis ? 'badge-success' : 'badge-danger'}">
                                ${detalhes.vagasDisponiveis ? '‚úì Vagas Dispon√≠veis' : '‚úó Esgotado'}
                            </span>
                        </p>
                        <div class="item-actions">
                            <button onclick="inscreverNoCurso(${curso.id})" class="btn-primary" ${!detalhes.vagasDisponiveis ? 'disabled' : ''}>
                                ‚ûï Inscrever-se
                            </button>
                        </div>
                    `;
                    lista.appendChild(div);
                }

            } catch (error) {
                console.error('Erro ao carregar cursos:', error);
                showAlert('Erro ao carregar cursos dispon√≠veis', 'error');
            }
        }

        async function carregarMinhasInscricoes() {
            try {
                const response = await fetch(`${API_URL}/inscricoes`);
                const todasInscricoes = await response.json();
                
                const minhasInscricoes = todasInscricoes.filter(i => i.aluno.id === alunoLogado.id);

                const lista = document.getElementById('listaMinhasInscricoes');
                lista.innerHTML = '';

                if (minhasInscricoes.length === 0) {
                    lista.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><h3>Voc√™ ainda n√£o possui inscri√ß√µes</h3><p>Explore os cursos dispon√≠veis e inscreva-se!</p></div>';
                    return;
                }

                for (const inscricao of minhasInscricoes) {
                    const statusClass = 
                        inscricao.status === 'PAGO' || inscricao.status === 'CONFIRMADA' || inscricao.status === 'CONCLUIDA' ? 'badge-success' :
                        inscricao.status === 'PENDENTE' ? 'badge-warning' :
                        'badge-danger';

                    const div = document.createElement('div');
                    div.className = 'data-item';
                    div.innerHTML = `
                        <h4>${inscricao.curso.nome}</h4>
                        <p><strong>Data de Inscri√ß√£o:</strong> ${new Date(inscricao.dataInscricao).toLocaleString('pt-BR')}</p>
                        <p><strong>Valor:</strong> R$ ${inscricao.curso.preco.toFixed(2)}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge ${statusClass}">${inscricao.status}</span>
                        </p>
                        <div class="item-actions">
                            ${inscricao.status === 'PENDENTE' ? 
                                `<button onclick="processarPagamento(${inscricao.id})" class="btn-primary">üí∞ Pagar Agora</button>` : ''}
                            ${inscricao.status !== 'CANCELADA' && inscricao.status !== 'CONCLUIDA' ? 
                                `<button onclick="cancelarInscricao(${inscricao.id})" class="btn-danger">‚ùå Cancelar</button>` : ''}
                            <button onclick="verDetalhesInscricao(${inscricao.id})" class="btn-outline">üìã Detalhes</button>
                        </div>
                    `;
                    lista.appendChild(div);
                }

            } catch (error) {
                console.error('Erro ao carregar inscri√ß√µes:', error);
                showAlert('Erro ao carregar suas inscri√ß√µes', 'error');
            }
        }

        async function carregarMeusPagamentos() {
            try {
                const response = await fetch(`${API_URL}/inscricoes`);
                const todasInscricoes = await response.json();
                
                const minhasInscricoes = todasInscricoes.filter(i => i.aluno.id === alunoLogado.id && i.pagamento);

                const lista = document.getElementById('listaMeusPagamentos');
                lista.innerHTML = '';

                if (minhasInscricoes.length === 0) {
                    lista.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><h3>Nenhum pagamento realizado</h3></div>';
                    return;
                }

                for (const inscricao of minhasInscricoes) {
                    const detalhesResp = await fetch(`${API_URL}/teste/inscricao/${inscricao.id}/detalhes`);
                    const detalhes = await detalhesResp.json();

                    if (detalhes.pagamento) {
                        const div = document.createElement('div');
                        div.className = 'data-item';
                        div.innerHTML = `
                            <h4>Pagamento - ${inscricao.curso.nome}</h4>
                            <p><strong>Valor:</strong> R$ ${detalhes.pagamento.valor.toFixed(2)}</p>
                            <p><strong>M√©todo:</strong> ${detalhes.pagamento.metodoPagamento}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge ${detalhes.pagamento.status === 'PAGO' ? 'badge-success' : 'badge-warning'}">
                                    ${detalhes.pagamento.status}
                                </span>
                            </p>
                            <p><strong>Data:</strong> ${new Date(inscricao.dataInscricao).toLocaleString('pt-BR')}</p>
                        `;
                        lista.appendChild(div);
                    }
                }

            } catch (error) {
                console.error('Erro ao carregar pagamentos:', error);
                showAlert('Erro ao carregar hist√≥rico de pagamentos', 'error');
            }
        }

        async function inscreverNoCurso(cursoId) {
            if (!confirm('Deseja se inscrever neste curso?')) return;

            try {
                const response = await fetch(
                    `${API_URL}/alunos/${alunoLogado.id}/inscrever?cursoId=${cursoId}`,
                    { method: 'POST' }
                );

                if (response.ok) {
                    showAlert('Inscri√ß√£o realizada com sucesso!', 'success');
                    carregarDadosAluno();
                    carregarCursosDisponiveis();
                } else {
                    const error = await response.json();
                    showAlert(error.mensagem || 'Erro ao realizar inscri√ß√£o', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao realizar inscri√ß√£o', 'error');
            }
        }

        async function processarPagamento(inscricaoId) {
            const metodo = prompt('Escolha o m√©todo de pagamento:\n1 - PIX\n2 - Cart√£o de Cr√©dito\n3 - Boleto');
            const metodos = { '1': 'PIX', '2': 'CARTAO_CREDITO', '3': 'BOLETO' };
            
            if (!metodos[metodo]) {
                showAlert('M√©todo de pagamento inv√°lido', 'error');
                return;
            }

            try {
                const response = await fetch(
                    `${API_URL}/alunos/${alunoLogado.id}/inscricoes/${inscricaoId}/pagamento?metodoPagamento=${metodos[metodo]}`,
                    { method: 'POST' }
                );

                if (response.ok) {
                    showAlert('Pagamento processado com sucesso!', 'success');
                    carregarDadosAluno();
                    carregarMinhasInscricoes();
                } else {
                    const error = await response.json();
                    showAlert(error.mensagem || 'Erro ao processar pagamento', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao processar pagamento', 'error');
            }
        }

        async function cancelarInscricao(inscricaoId) {
            if (!confirm('Deseja realmente cancelar esta inscri√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.')) return;

            try {
                const response = await fetch(
                    `${API_URL}/alunos/${alunoLogado.id}/inscricoes/${inscricaoId}/cancelar`,
                    { method: 'POST' }
                );

                if (response.ok) {
                    const reembolso = await response.json();
                    if (reembolso.valorReembolsado > 0) {
                        showAlert(`Inscri√ß√£o cancelada! Voc√™ receber√° um reembolso de R$ ${reembolso.valorReembolsado.toFixed(2)}`, 'success');
                    } else {
                        showAlert('Inscri√ß√£o cancelada com sucesso!', 'success');
                    }
                    carregarDadosAluno();
                    carregarMinhasInscricoes();
                } else {
                    const error = await response.json();
                    showAlert(error.mensagem || 'Erro ao cancelar inscri√ß√£o', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao cancelar inscri√ß√£o', 'error');
            }
        }

        async function verDetalhesInscricao(id) {
            try {
                const response = await fetch(`${API_URL}/teste/inscricao/${id}/detalhes`);
                const data = await response.json();
                
                let html = `
                    <h3>Detalhes da Inscri√ß√£o</h3>
                    <p><strong>Curso:</strong> ${data.curso.nome}</p>
                    <p><strong>Data:</strong> ${new Date(data.inscricao.dataInscricao).toLocaleString('pt-BR')}</p>
                    <p><strong>Status:</strong> ${data.status}</p>
                    <p><strong>Est√° Ativa:</strong> ${data.isAtiva ? 'Sim' : 'N√£o'}</p>
                    <p><strong>Pode Cancelar:</strong> ${data.podeCancelar ? 'Sim' : 'N√£o'}</p>
                    <p><strong>Tem Direito a Reembolso:</strong> ${data.temDireitoReembolso ? 'Sim' : 'N√£o'}</p>
                `;
                
                if (data.pagamento) {
                    html += `
                        <h4>Pagamento</h4>
                        <p><strong>Valor:</strong> R$ ${data.pagamento.valor.toFixed(2)}</p>
                        <p><strong>M√©todo:</strong> ${data.pagamento.metodoPagamento}</p>
                        <p><strong>Status:</strong> ${data.pagamento.status}</p>
                    `;
                }
                
                mostrarModal('Detalhes da Inscri√ß√£o', html);
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao carregar detalhes', 'error');
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('session');
                window.location.href = 'login.html';
            }
        }

        function voltarLogin() {
            if (confirm('Deseja voltar para a tela de login? Voc√™ ser√° desconectado.')) {
                localStorage.removeItem('session');
                window.location.href = 'login.html';
            }
        }

        function formatarCPF(cpf) {
            if (!cpf) return '';
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
    </script>
</body>
</html>
